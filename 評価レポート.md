# Kabuweb アプリケーション評価レポート

## 📋 アプリケーション概要

**Kabuweb** は、日本株の取引記録管理と価格アラート通知を行うためのWebアプリケーションです。

### 主な機能
1. **取引記録管理**: 株式の買い/売り取引を記録・管理
2. **価格アラート**: 指定した目標価格に近づいた際にDiscordへ通知
3. **リアルタイム価格取得**: Google Financeから株価を取得
4. **ユーザー認証**: JWT認証によるユーザー管理機能

### 技術スタック
- **バックエンド**: Spring Boot 3.5.9 (Java 17)
- **フロントエンド**: React + Vite
- **データベース**: MySQL
- **認証**: JWT (JSON Web Token)
- **スケジューリング**: Spring Scheduling
- **Webスクレイピング**: JSoup

---

## 📁 フォルダ構造の評価

### 現在の構造
```
src/main/java/com/kabu/kabuweb/
├── controller/
│   └── TradeController.java
├── repository/
│   ├── TradeRepository.java
│   └── UserRepository.java
├── Trade.java
├── User.java
└── KabuwebApplication.java
```

### 評価結果

#### ✅ 良い点
1. **基本的なMVC構造**: Controller、Repositoryの分離ができている
2. **パッケージ分離**: コントローラーとリポジトリが適切に分離されている

#### ❌ 問題点

1. **エンティティクラスの重複**
   - `src/main/java/com/kabu/kabuweb/User.java` と `entity/User.java` が両方存在
   - パッケージ構造が一貫していない
   - `UserRepository`は`com.kabu.kabuweb.User`を参照、`AuthController`は`com.kabu.kabuweb.entity.User`を参照

2. **エンティティクラスの配置が不統一**
   - `Trade.java`はルートパッケージに配置
   - `User.java`は`entity`パッケージに配置（推奨）
   - 統一性がない

3. **推奨される構造**
   ```
   src/main/java/com/kabu/kabuweb/
   ├── controller/
   │   ├── TradeController.java
   │   └── AuthController.java
   ├── entity/          ← エンティティを統一
   │   ├── Trade.java
   │   └── User.java
   ├── repository/
   │   ├── TradeRepository.java
   │   └── UserRepository.java
   ├── service/         ← サービス層を追加
   │   └── UserDetailsServiceImpl.java
   ├── dto/             ← DTOを追加
   │   └── AuthRequest.java
   ├── config/          ← 設定クラス
   │   ├── SecurityConfig.java
   │   └── JwtAuthenticationFilter.java
   ├── util/            ← ユーティリティ
   │   └── JwtUtil.java
   └── KabuwebApplication.java
   ```

---

## 🔍 コードの正確性評価

### 1. TradeController.java

#### ❌ 重大な問題

**問題1: @Scheduledと@GetMappingの併用**
```java
@GetMapping("/check")
@Scheduled(fixedRate = 60000)
public String checkPricesAndNotify() {
```
- `@Scheduled`はHTTPエンドポイントではなく、バックグラウンドタスク用
- `@GetMapping`と併用すると、スケジューラーが正しく動作しない可能性がある
- **修正**: `/check`エンドポイントとスケジューラーを分離する

**問題2: Discord Webhook URLのハードコード**
```java
private static final String WEBHOOK_URL = "https://discordapp.com/api/webhooks/...";
```
- セキュリティリスク: Webhook URLが公開される
- **修正**: 環境変数または設定ファイルに移動

**問題3: JSON文字列の構文エラー**
```java
String json = """
    {
"content": "<@%s> %s が %s に近付きました (現在%s")
    }
    """.formatted(mention, name, target, current);
```
- 閉じ括弧が不足している（`(現在%s"` → `(現在%s)"`）
- JSONのフォーマットが不正

**問題4: 未使用のインポート**
```java
import org.hibernate.persister.collection.ElementPropertyMapping;
```
- 使用されていないインポート

**問題5: セキュリティ設定の不整合**
- `SecurityConfig`で`/trades/**`が認証不要になっているが、実際には認証が必要なエンドポイント
- フロントエンドのコメントに「認証ヘッダーは不要」と記載されているが、セキュリティ設定と矛盾

#### ⚠️ 改善点

1. **エラーハンドリング**: `fetchCurrentPrice`で例外が発生した場合、`-1.0`を返しているが、より適切なエラーハンドリングが必要
2. **ログ出力**: デバッグ用の`System.out.println`が残っている
3. **価格取得のリトライ機能**: ネットワークエラー時のリトライ機能がない

### 2. Trade.java

#### ❌ 問題点

**問題1: @Dataアノテーションと手動getter/setterの重複**
```java
@Data  // ← Lombokがgetter/setterを自動生成
public class Trade {
    // ...
    public Long getId() { return id;}  // ← 手動で定義（不要）
    public void setId(Long id) { this.id = id;}  // ← 手動で定義（不要）
```
- `@Data`アノテーションがあるため、手動のgetter/setterは不要
- **修正**: 手動のgetter/setterを削除するか、`@Data`を削除する

**問題2: コメントのタイポ**
```java
//constracta  ← "constructor"のタイポ
```

**問題3: userIDフィールドの命名**
- `userID`は`userId`（キャメルケース）に統一すべき

### 3. User.java (重複問題)

#### ❌ 重大な問題

**問題1: 2つのUserクラスが存在**
- `src/main/java/com/kabu/kabuweb/User.java`
- `entity/User.java`
- どちらを使用すべきか不明確
- コンパイルエラーの原因になる可能性

**問題2: インポートの不整合**
- `UserRepository`: `com.kabu.kabuweb.User`をインポート
- `AuthController`: `com.kabu.kabuweb.entity.User`をインポート
- `UserDetailsServiceImpl`: `com.kabu.kabuweb.entity.User`をインポート

### 4. SecurityConfig.java

#### ⚠️ 改善点

**問題1: CORS設定が緩すぎる**
```java
configuration.setAllowedOriginPatterns(List.of("*"));
configuration.setAllowCredentials(true);
```
- `allowCredentials(true)`と`allowedOriginPatterns("*")`の組み合わせは推奨されない
- **修正**: 特定のオリジンを指定する

**問題2: /trades/**の認証設定**
- 現在は認証不要だが、実際には認証が必要なエンドポイントがある
- フロントエンドとバックエンドの整合性を確認する必要がある

### 5. KabuwebApplication.java

#### ⚠️ 改善点

**問題1: デバッグコードが残っている**
```java
System.out.println(System.getenv("BD_PASSWORD"));
```
- 本番環境でパスワードがログに出力される可能性
- **修正**: ログ出力を削除または適切なログレベルに変更

**問題2: User-Agentの設定**
- HTTPエージェントの設定がハードコードされている
- 設定ファイルに移動することを推奨

### 6. その他の問題

1. **リポジトリのパッケージ不一致**
   - `repository.java/UserRepository.java`というパスが存在する可能性
   - 正しくは`repository/UserRepository.java`

2. **DTOクラスの不足**
   - `Trade`エンティティを直接リクエスト/レスポンスで使用している
   - DTOクラスを作成して分離すべき

---

## 📊 総合評価

### コード品質スコア: 6.5/10

#### 強み
- ✅ 基本的なSpring Bootの構造は理解されている
- ✅ JWT認証の実装ができている
- ✅ スケジューラー機能の実装ができている
- ✅ フロントエンドとバックエンドの連携ができている

#### 弱み
- ❌ エンティティクラスの重複とパッケージ構造の不統一
- ❌ セキュリティ設定の不整合
- ❌ コードの重複（getter/setter）
- ❌ エラーハンドリングが不十分
- ❌ ハードコードされた設定値（Webhook URL、シークレットキー）

---

## 🔧 推奨される修正事項（優先順位順）

### 高優先度

1. **Userエンティティの重複を解消**
   - `src/main/java/com/kabu/kabuweb/User.java`を削除
   - すべての参照を`com.kabu.kabuweb.entity.User`に統一

2. **Tradeエンティティをentityパッケージに移動**
   - パッケージ構造を統一

3. **TradeControllerの@Scheduled問題を修正**
   - `/check`エンドポイントとスケジューラーを分離

4. **JSON文字列の構文エラーを修正**
   - `sendToDiscord`メソッドのJSONフォーマットを修正

5. **セキュリティ設定の見直し**
   - `/trades/**`の認証要件を明確化

### 中優先度

6. **Trade.javaのgetter/setter重複を解消**
   - `@Data`を使用する場合は手動getter/setterを削除

7. **Discord Webhook URLを環境変数に移動**
   - セキュリティ向上

8. **JWTシークレットキーを環境変数に移動**
   - セキュリティ向上

9. **CORS設定の見直し**
   - 特定のオリジンを指定

### 低優先度

10. **エラーハンドリングの改善**
    - より適切な例外処理

11. **ログ出力の改善**
    - `System.out.println`を適切なロガーに置き換え

12. **DTOクラスの追加**
    - エンティティとDTOを分離

---

## 📝 まとめ

このアプリケーションは基本的な機能は実装されていますが、以下の点で改善が必要です：

1. **構造の統一**: エンティティクラスの配置とパッケージ構造を統一
2. **セキュリティ**: ハードコードされた機密情報を環境変数に移動
3. **コード品質**: 重複コードの削除、エラーハンドリングの改善
4. **設定の見直し**: セキュリティ設定とCORS設定の最適化

これらの修正により、より保守性が高く、セキュアなアプリケーションになります。
